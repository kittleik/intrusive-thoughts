<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üß† Living Mind</title>
  <style>
    :root {
      /* Base colors */
      --bg: #0a0a0f;
      --surface: #12121a;
      --border: #1e1e2e;
      --text: #c9c9d9;
      --text-dim: #6b6b80;
      --text-dimmer: #444456;
      
      /* Mood colors - will be overridden by JS */
      --mood-color: #f59e0b;
      --mood-bg: rgba(245, 158, 11, 0.1);
      --mood-border: rgba(245, 158, 11, 0.3);
      
      /* Status colors */
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
      --info: #3b82f6;
    }

    /* Reset and base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      line-height: 1.6;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* Hero Section - Current State of Mind */
    .hero {
      min-height: 30vh;
      padding: 3rem 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--mood-bg), transparent);
      position: relative;
      margin-bottom: 3rem;
      border-bottom: 1px solid var(--mood-border);
    }

    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 50% 50%, var(--mood-bg), transparent 70%);
      opacity: 0.3;
      pointer-events: none;
    }

    .hero-content {
      text-align: center;
      z-index: 1;
      position: relative;
    }

    .mood-emoji {
      font-size: 6rem;
      margin-bottom: 1rem;
      display: block;
      filter: drop-shadow(0 0 20px var(--mood-color));
    }

    .mood-name {
      font-size: 3rem;
      color: var(--mood-color);
      margin-bottom: 0.5rem;
      text-shadow: 0 0 30px var(--mood-color);
    }

    .mood-reason {
      font-size: 1.5rem;
      color: var(--text-dim);
      font-style: italic;
      margin-bottom: 2rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .mood-meta {
      display: flex;
      justify-content: center;
      gap: 3rem;
      flex-wrap: wrap;
      margin-top: 2rem;
    }

    .mood-meta-item {
      text-align: center;
    }

    .mood-meta-label {
      display: block;
      color: var(--text-dimmer);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .mood-meta-value {
      display: block;
      color: var(--mood-color);
      font-size: 1.25rem;
      font-weight: bold;
    }

    /* Section styling */
    .section {
      margin-bottom: 4rem;
      position: relative;
    }

    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .section-icon {
      font-size: 1.5rem;
      margin-right: 0.75rem;
      color: var(--mood-color);
    }

    .section-title {
      font-size: 1.5rem;
      color: var(--text);
    }

    .section-subtitle {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-left: auto;
    }

    /* Live Thought Stream */
    .thought-stream {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      max-height: 500px;
      overflow-y: auto;
    }

    .thought-item {
      padding: 1rem;
      border-left: 3px solid var(--mood-color);
      background: rgba(255, 255, 255, 0.02);
      border-radius: 0 8px 8px 0;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .thought-item.rejection {
      opacity: 0.5;
      border-left-color: var(--text-dimmer);
    }

    .thought-item:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateX(4px);
    }

    .thought-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-dim);
    }

    .thought-type {
      background: var(--mood-color);
      color: var(--bg);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
      text-transform: uppercase;
    }

    .thought-content {
      color: var(--text);
      line-height: 1.5;
    }

    .genuineness-score {
      display: inline-block;
      background: var(--info);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }

    /* Grid layouts */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .two-col-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      border-color: var(--mood-border);
      background: rgba(255, 255, 255, 0.02);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--mood-color);
      display: block;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    .stat-detail {
      color: var(--text-dimmer);
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }

    /* Mood Flow Timeline */
    .mood-timeline {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .timeline-header {
      text-align: center;
      margin-bottom: 2rem;
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    .timeline-dots {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding: 0 1rem;
    }

    .timeline-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .timeline-dot:hover::after {
      content: attr(data-mood);
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg);
      color: var(--text);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      white-space: nowrap;
      border: 1px solid var(--border);
    }

    .timeline-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-dimmer);
    }

    /* Trust & Genuineness */
    .trust-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .trust-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .trust-metric {
      text-align: center;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
    }

    .trust-score {
      font-size: 2rem;
      font-weight: bold;
      color: var(--mood-color);
      margin-bottom: 0.25rem;
    }

    .trust-label {
      color: var(--text-dim);
      font-size: 0.85rem;
    }

    /* Night Workshop */
    .workshop-summary {
      background: linear-gradient(135deg, var(--surface), rgba(255, 255, 255, 0.02));
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 2rem;
    }

    .workshop-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .workshop-title {
      font-size: 1.25rem;
      color: var(--mood-color);
    }

    .workshop-date {
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    .energy-arc {
      width: 100%;
      height: 60px;
      background: var(--bg);
      border-radius: 8px;
      margin: 1rem 0;
      position: relative;
      overflow: hidden;
    }

    /* Achievements */
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .achievement {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .achievement:hover {
      border-color: var(--mood-border);
      transform: translateY(-2px);
    }

    .achievement-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .achievement-icon {
      font-size: 1.5rem;
      margin-right: 0.75rem;
    }

    .achievement-name {
      font-weight: bold;
      color: var(--text);
    }

    .achievement-points {
      margin-left: auto;
      background: var(--mood-color);
      color: var(--bg);
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.8rem;
    }

    .achievement-desc {
      color: var(--text-dim);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .achievement-date {
      color: var(--text-dimmer);
      font-size: 0.8rem;
    }

    /* Health Status */
    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .health-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .health-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 0.75rem;
      flex-shrink: 0;
    }

    .health-indicator.green { background: var(--success); }
    .health-indicator.yellow { background: var(--warning); }
    .health-indicator.red { background: var(--danger); }

    .health-label {
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    /* ASCII Art */
    .ascii-art {
      font-family: monospace;
      color: var(--text-dimmer);
      font-size: 0.8rem;
      line-height: 1;
      text-align: center;
      margin: 2rem 0;
      white-space: pre;
    }

    /* Loading states */
    .loading {
      color: var(--text-dim);
      text-align: center;
      padding: 2rem;
    }

    .loading::after {
      content: "‚ö°";
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 0 0.5rem;
      }
      
      .mood-emoji {
        font-size: 4rem;
      }
      
      .mood-name {
        font-size: 2rem;
      }
      
      .mood-reason {
        font-size: 1.2rem;
      }
      
      .mood-meta {
        gap: 1.5rem;
      }
      
      .two-col-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .timeline-dots {
        padding: 0;
      }
      
      .timeline-dot {
        width: 12px;
        height: 12px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .achievements-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Hero: Current State of Mind -->
    <section class="hero">
      <div class="hero-content">
        <span class="mood-emoji" id="moodEmoji">ü§î</span>
        <h1 class="mood-name" id="moodName">Loading...</h1>
        <p class="mood-reason" id="moodReason">"..."</p>
        
        <div class="mood-meta">
          <div class="mood-meta-item">
            <span class="mood-meta-label">Duration</span>
            <span class="mood-meta-value" id="moodDuration">--</span>
          </div>
          <div class="mood-meta-item">
            <span class="mood-meta-label">Energy</span>
            <span class="mood-meta-value" id="energyLevel">--</span>
          </div>
          <div class="mood-meta-item">
            <span class="mood-meta-label">Day Personality</span>
            <span class="mood-meta-value" id="dayPersonality">--</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Live Thought Stream -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">‚ö°</span>
        <h2 class="section-title">Live Thought Stream</h2>
        <span class="section-subtitle">consciousness happening now</span>
      </div>
      
      <div class="thought-stream" id="thoughtStream">
        <div class="loading">Loading thought stream...</div>
      </div>
    </section>

    <!-- Session Intelligence -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üßÆ</span>
        <h2 class="section-title">Intrusive Thoughts Activity</h2>
        <span class="section-subtitle">skill-triggered sessions only</span>
      </div>
      
      <div class="stats-grid" id="sessionStats">
        <div class="stat-card">
          <span class="stat-value" id="totalSessions">--</span>
          <span class="stat-label">Completed</span>
          <div class="stat-detail" id="sessionDetail">--</div>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="totalMessages">--</span>
          <span class="stat-label">Thought Picks</span>
          <div class="stat-detail" id="messageDetail">--</div>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="totalToolCalls">--</span>
          <span class="stat-label">Achievements</span>
          <div class="stat-detail" id="toolDetail">--</div>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="totalCost">--</span>
          <span class="stat-label">Points</span>
          <div class="stat-detail" id="costDetail">--</div>
        </div>
      </div>
    </section>

    <div class="two-col-grid">
      <!-- Mood Flow -->
      <section class="section">
        <div class="section-header">
          <span class="section-icon">üìä</span>
          <h2 class="section-title">Mood Flow</h2>
        </div>
        
        <div class="mood-timeline">
          <div class="timeline-header">Daily Mood Picks</div>
          <div class="timeline-dots" id="moodTimeline">
            <!-- Dots will be generated by JS -->
          </div>
          <div class="timeline-labels">
            <span id="timelineStart">--</span>
            <span id="timelineEnd">Today</span>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-value" id="currentStreak">--</span>
            <span class="stat-label">Current Streak</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="entropyStatus">--</span>
            <span class="stat-label">Entropy</span>
          </div>
        </div>
      </section>

      <!-- Trust & Genuineness -->
      <section class="section">
        <div class="section-header">
          <span class="section-icon">üéØ</span>
          <h2 class="section-title">Trust & Genuineness</h2>
        </div>
        
        <div class="trust-section">
          <div class="trust-metrics" id="trustMetrics">
            <div class="trust-metric">
              <div class="trust-score" id="overallTrust">--</div>
              <div class="trust-label">Overall Trust</div>
            </div>
            <div class="trust-metric">
              <div class="trust-score" id="derivedTrust">--</div>
              <div class="trust-label">Derived</div>
            </div>
            <div class="trust-metric">
              <div class="trust-score" id="filteredThoughts">--</div>
              <div class="trust-label">Filtered</div>
            </div>
          </div>
          
          <div class="stat-detail" id="filteringStats">
            <!-- Filtering statistics will go here -->
          </div>
        </div>
      </section>
    </div>

    <!-- Night Workshop -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üåô</span>
        <h2 class="section-title">Night Workshop</h2>
        <span class="section-subtitle">what shipped while sleeping</span>
      </div>
      
      <div class="workshop-summary" id="nightWorkshop">
        <div class="workshop-header">
          <div class="workshop-title">Last Workshop Session</div>
          <div class="workshop-date" id="workshopDate">--</div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-value" id="workshopSessions">--</span>
            <span class="stat-label">Sessions</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="workshopShipped">--</span>
            <span class="stat-label">Shipped</span>
          </div>
        </div>
        
        <div class="energy-arc" id="energyArc">
          <!-- Energy arc visualization -->
        </div>
      </div>
    </section>

    <!-- Schedule / Cron Jobs -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üìÖ</span>
        <h2 class="section-title">Scheduled Jobs</h2>
        <span class="section-subtitle">OpenClaw cron jobs</span>
      </div>
      
      <div id="scheduleList" style="display: flex; flex-direction: column; gap: 0.5rem;">
        <div class="loading">Loading schedule...</div>
      </div>
      
      <div style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-dimmer);">
        Current phase: <span id="currentPhase">--</span>
      </div>
    </section>

    <!-- Achievements -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üèÜ</span>
        <h2 class="section-title">Achievements</h2>
        <span class="section-subtitle">milestones reached</span>
      </div>
      
      <div class="achievements-grid" id="achievements">
        <!-- Achievements will be loaded here -->
      </div>
    </section>

    <!-- ASCII Art Separator -->
    <div class="ascii-art" id="asciiArt">
      ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
      ‚îÇ     intrusive-thoughts v0.1.3       ‚îÇ
      ‚îÇ     uptime: <span id="uptime">calculating...</span>      ‚îÇ
      ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
    </div>

    <!-- Health Status -->
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üíö</span>
        <h2 class="section-title">System Health</h2>
      </div>
      
      <div class="health-grid" id="healthGrid">
        <!-- Health indicators will be loaded here -->
      </div>
    </section>
  </div>

  <script>
    // Mood color mappings
    const moodColors = {
      'hyperfocus': '#f59e0b',
      'curious': '#3b82f6',
      'social': '#ec4899',
      'cozy': '#22c55e',
      'chaotic': '#ef4444',
      'philosophical': '#8b5cf6',
      'restless': '#f97316',
      'determined': '#06b6d4'
    };

    // State
    let currentMood = 'curious';
    let refreshInterval;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadDashboard();
      startAutoRefresh();
    });

    // Set mood-based colors
    function setMoodColors(mood) {
      currentMood = mood;
      const color = moodColors[mood] || moodColors.curious;
      const root = document.documentElement;
      
      root.style.setProperty('--mood-color', color);
      root.style.setProperty('--mood-bg', `${color}20`);
      root.style.setProperty('--mood-border', `${color}50`);
    }

    // Load main dashboard data
    async function loadDashboard() {
      try {
        await Promise.all([
          loadCurrentState(),
          loadThoughtStream(),
          loadSessionStats(),
          loadMoodTimeline(),
          loadTrustData(),
          loadNightWorkshop(),
          loadSchedule(),
          loadAchievements(),
          loadHealthStatus()
        ]);
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Load current mood/state
    async function loadCurrentState() {
      try {
        const response = await fetch('/api/systems');
        const data = await response.json();
        
        const cm = data.mood?.current_mood;
        if (cm) {
          setMoodColors(cm.id.toLowerCase());
          
          document.getElementById('moodEmoji').textContent = cm.emoji || getMoodEmoji(cm.id);
          document.getElementById('moodName').textContent = cm.name || cm.id;
          document.getElementById('moodReason').textContent = `"${cm.mood_reason || cm.description || 'Processing...'}"`;
          
          // Calculate duration from mood date
          const moodDate = new Date(cm.date + 'T07:00:00');
          const duration = Math.floor((Date.now() - moodDate.getTime()) / 1000);
          document.getElementById('moodDuration').textContent = formatDuration(Math.max(0, duration));
          
          // Energy from boosted traits count or default
          const energy = cm.boosted_traits ? Math.min(100, cm.boosted_traits.length * 15) : 50;
          document.getElementById('energyLevel').textContent = `${energy}%`;
          document.getElementById('dayPersonality').textContent = getDayPersonality();
        }
      } catch (error) {
        console.error('Error loading current state:', error);
      }
    }

    // Load thought stream ‚Äî only intrusive-thoughts skill activity
    async function loadThoughtStream() {
      try {
        // Use history.json (intrusive-thoughts own log) not session logs
        const response = await fetch('/api/stream');
        const data = await response.json();
        
        const container = document.getElementById('thoughtStream');
        // Filter: keep intrusive-thoughts activity, exclude raw OpenClaw session logs
        const skillEntries = (data || []).filter(item => {
          // Filter OUT raw session log entries (they have model names as mood, session UUIDs as thought_id)
          if (item.mood && item.mood.includes('claude')) return false;
          if (item.details?.model && !item.type) return false;
          // Filter out entries with "? ‚Üí ?" broken data
          if (item.summary && item.summary.includes('? ‚Üí')) return false;
          // Keep everything else (history.json entries are all intrusive-thoughts activity)
          return true;
        });
        
        if (skillEntries.length > 0) {
          container.innerHTML = skillEntries.slice(0, 15).map(item => {
            const typeEmoji = {pick: '‚úÖ', rejection: '‚ùå', mood_drift: 'üåä', mood_pick: 'üéØ', night_workshop: 'üåô', morning_ritual: 'üåÖ', activity: '‚ö°', observation: 'üëÅÔ∏è'}[item.type] || 'üí≠';
            const isRejection = item.type === 'rejection' || item.rejected;
            return `
            <div class="thought-item ${isRejection ? 'rejection' : ''}">
              <div class="thought-header">
                <span class="thought-type">${typeEmoji} ${item.type || 'thought'}</span>
                <span>${formatTime(item.timestamp)}</span>
              </div>
              <div class="thought-content">${item.summary || item.content || item.thought || '...'}</div>
              ${item.skills_used && item.skills_used.length > 0 ?
                `<div style="margin-top: 0.3rem; font-size: 0.75rem; color: var(--mood-color);">üîß ${item.skills_used.join(', ')}</div>` : ''
              }
              ${item.genuineness_score !== undefined ? 
                `<span class="genuineness-score">${Math.round(item.genuineness_score * 100)}% genuine</span>` : ''
              }
            </div>`;
          }).join('');
        } else {
          container.innerHTML = '<div class="loading">No intrusive thoughts activity yet ‚Äî waiting for next cron trigger...</div>';
        }
      } catch (error) {
        console.error('Error loading thought stream:', error);
        document.getElementById('thoughtStream').innerHTML = '<div class="loading">Error loading stream</div>';
      }
    }

    // Load activity statistics from history.json (intrusive-thoughts only)
    async function loadSessionStats() {
      try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        if (data) {
          document.getElementById('totalSessions').textContent = data.total_completed || 0;
          document.getElementById('totalMessages').textContent = data.total_picks || 0;
          document.getElementById('totalToolCalls').textContent = data.achievements || 0;
          document.getElementById('totalCost').textContent = data.points || 0;
          
          document.getElementById('sessionDetail').textContent = '';
          document.getElementById('messageDetail').textContent = '';
          document.getElementById('toolDetail').textContent = '';
          document.getElementById('costDetail').textContent = '';
        }
      } catch (error) {
        console.error('Error loading activity stats:', error);
      }
    }

    // Load mood timeline
    async function loadMoodTimeline() {
      try {
        const response = await fetch('/api/mood-timeline');
        const data = await response.json();
        
        if (data && data.length > 0) {
          const container = document.getElementById('moodTimeline');
          // Deduplicate: one mood per day (first entry = morning pick)
          const byDate = {};
          data.forEach(day => {
            if (day.date && !byDate[day.date]) byDate[day.date] = day;
          });
          const uniqueDays = Object.values(byDate);
          const dots = uniqueDays.slice(-14).map(day => {
            const color = moodColors[day.mood?.toLowerCase()] || '#666';
            return `
              <div class="timeline-dot" 
                   style="background-color: ${color}; border-color: ${color};"
                   data-mood="${day.mood || 'unknown'}"
                   title="${day.date}: ${day.mood} ${day.emoji || ''}">
              </div>
            `;
          }).join('');
          
          container.innerHTML = dots;
          
          // Set timeline labels
          if (uniqueDays.length > 0) {
            // Use the date string directly to avoid timezone issues
            const startStr = uniqueDays[0].date || '';
            const parts = startStr.split('-');
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            if (parts.length === 3) {
              document.getElementById('timelineStart').textContent = `${months[parseInt(parts[1])-1]} ${parseInt(parts[2])}`;
            }
          }
        }

        // Load streaks
        const streaksResponse = await fetch('/api/streaks');
        const streaksData = await streaksResponse.json();
        
        if (streaksData) {
          // Find longest streak
          const streakEntries = Object.entries(streaksData);
          const longest = streakEntries.reduce((max, [k, v]) => (v.count > (max.count || 0)) ? {name: k, ...v} : max, {count: 0});
          document.getElementById('currentStreak').textContent = longest.count ? `${longest.count} ${longest.name}` : '0';
          document.getElementById('entropyStatus').textContent = streakEntries.length >= 4 ? 'diverse' : streakEntries.length >= 2 ? 'stable' : 'low';
        }
      } catch (error) {
        console.error('Error loading mood timeline:', error);
      }
    }

    // Load trust data
    async function loadTrustData() {
      try {
        const response = await fetch('/api/trust');
        const data = await response.json();
        
        if (data) {
          const td = data.trust_data || data;
          const trustLevel = td.trust_level || td.overall || 0;
          document.getElementById('overallTrust').textContent = `${Math.round(trustLevel * 100)}%`;
          
          // Derived from categories
          const cats = td.action_categories || {};
          const catEntries = Object.entries(cats);
          const avgDerived = catEntries.length > 0 ? catEntries.reduce((s, [,v]) => s + (v.trust || 0), 0) / catEntries.length : 0;
          document.getElementById('derivedTrust').textContent = `${Math.round(avgDerived * 100)}%`;
          document.getElementById('filteredThoughts').textContent = td.history?.length || 0;
          
          const stats = catEntries.map(([k, v]) => `${k.replace('_',' ')}: ${Math.round((v.trust||0)*100)}%`).join(' ‚Ä¢ ');
          document.getElementById('filteringStats').textContent = stats || 'no category data';
        }
      } catch (error) {
        console.error('Error loading trust data:', error);
      }
    }

    // Load night workshop data
    async function loadNightWorkshop() {
      try {
        const response = await fetch('/api/night-stats');
        const data = await response.json();
        
        if (data) {
          document.getElementById('workshopDate').textContent = data.date || 'No workshop yet';
          document.getElementById('workshopSessions').textContent = data.sessions || 0;
          document.getElementById('workshopShipped').textContent = 
            Array.isArray(data.shipped) ? data.shipped.length : (data.shipped || 0);
          
          // Show summary text and shipped items
          const energyArc = document.getElementById('energyArc');
          const parts = [];
          if (data.summary) parts.push(data.summary);
          if (data.energy_avg && data.energy_avg !== 'none') parts.push(`Energy: ${data.energy_avg}`);
          if (Array.isArray(data.shipped) && data.shipped.length > 0) {
            parts.push('Shipped: ' + data.shipped.join(', '));
          }
          if (data.night_entries && data.night_entries.length > 0) {
            parts.push(...data.night_entries.map(e => `‚Ä¢ ${e.summary || e.thought_id}`));
          }
          energyArc.innerHTML = parts.length > 0 
            ? `<div style="color: var(--text-dim); font-size: 0.85rem; line-height: 1.6;">${parts.join('<br>')}</div>`
            : '<div style="color: var(--text-dimmer);">No workshop data ‚Äî next session tonight 03:00-07:00</div>';
        }
      } catch (error) {
        console.error('Error loading night workshop:', error);
      }
    }

    // Load schedule / cron jobs
    async function loadSchedule() {
      try {
        const response = await fetch('/api/schedule');
        const data = await response.json();
        
        const container = document.getElementById('scheduleList');
        document.getElementById('currentPhase').textContent = data.current_phase || 'unknown';
        
        if (data.schedule && data.schedule.length > 0) {
          // Hide disabled template jobs
          const activeJobs = data.schedule.filter(job => job.enabled);
          container.innerHTML = activeJobs.map(job => {
            const statusDot = !job.enabled ? '‚è∏Ô∏è' : 
                             job.last_status === 'ok' ? 'üü¢' : 
                             job.last_status === 'error' ? 'üî¥' : '‚ö™';
            
            // Human-readable schedule
            let scheduleText = job.schedule_expr;
            if (job.schedule_type === 'cron') {
              // Parse simple cron patterns
              const parts = job.schedule_expr.split(' ');
              if (parts.length >= 5) {
                const mins = parts[0];
                const hours = parts[1].split(',').map(h => `${h.padStart(2,'0')}:${mins.padStart(2,'0')}`).join(', ');
                scheduleText = `Daily at ${hours}`;
              }
            } else if (job.schedule_type === 'at') {
              const d = new Date(job.schedule_expr);
              scheduleText = `One-shot: ${d.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})} today`;
            }
            
            // Last run info - human readable
            let lastRunText = '';
            if (job.last_run) {
              const lastDate = new Date(job.last_run);
              const agoMs = Date.now() - lastDate.getTime();
              const agoMin = Math.round(agoMs / 60000);
              let agoStr;
              if (agoMin < 60) agoStr = `${agoMin}m ago`;
              else if (agoMin < 1440) agoStr = `${Math.floor(agoMin/60)}h ${agoMin%60}m ago`;
              else agoStr = `${Math.floor(agoMin/1440)}d ago`;
              
              const timeStr = lastDate.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
              const duration = job.last_duration_ms ? ` (${Math.round(job.last_duration_ms/1000)}s)` : '';
              lastRunText = `Ran ${timeStr} ¬∑ ${agoStr}${duration}`;
            }
            
            // Next run - human readable  
            let nextRunText = '';
            if (job.next_run) {
              const next = new Date(job.next_run);
              const inMs = next.getTime() - Date.now();
              const inMin = Math.round(inMs / 60000);
              const nextTime = next.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
              let inStr;
              if (inMin <= 0) inStr = 'due now';
              else if (inMin < 60) inStr = `in ${inMin}m`;
              else inStr = `in ${Math.floor(inMin/60)}h ${inMin%60}m`;
              nextRunText = `Next: ${nextTime} (${inStr})`;
            }
            
            return `
            <div style="display: flex; align-items: center; gap: 0.8rem; padding: 0.6rem 0.8rem; background: var(--surface); border-radius: 8px; border: 1px solid var(--border); ${!job.enabled ? 'opacity: 0.5;' : ''}">
              <span style="font-size: 1.1rem;">${statusDot}</span>
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 0.9rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${job.name}</div>
                <div style="font-size: 0.75rem; color: var(--text-dim);">${scheduleText}${job.delete_after_run ? ' (one-shot)' : ''}</div>
              </div>
              <div style="text-align: right; font-size: 0.7rem; color: var(--text-dimmer); white-space: nowrap;">
                ${lastRunText ? `<div>${lastRunText}</div>` : ''}
                ${nextRunText ? `<div style="color: var(--mood-color);">${nextRunText}</div>` : ''}
              </div>
            </div>`;
          }).join('');
        } else {
          container.innerHTML = '<div class="loading">No scheduled jobs found</div>';
        }
      } catch (error) {
        console.error('Error loading schedule:', error);
      }
    }

    // Load achievements
    async function loadAchievements() {
      try {
        const response = await fetch('/api/achievements');
        const data = await response.json();
        
        const earned = data?.earned || data || [];
        const allDefs = data?.all_achievements?.achievements || {};
        const container = document.getElementById('achievements');
        
        if (earned.length > 0) {
          container.innerHTML = earned.slice(0, 12).map(a => {
            const def = allDefs[a.id] || {};
            return `
            <div class="achievement">
              <div class="achievement-header">
                <span class="achievement-icon">${(def.name || '').match(/[^\w\s]/)?.[0] || 'üèÜ'}</span>
                <span class="achievement-name">${def.name || a.id}</span>
                <span class="achievement-points">${def.points || 0}pt</span>
              </div>
              <div class="achievement-desc">${a.context || def.description || ''}</div>
              <div class="achievement-date">${new Date(a.earned_at).toLocaleDateString()}</div>
            </div>`;
          }).join('');
        } else {
          container.innerHTML = '<div class="loading">No achievements yet...</div>';
        }
      } catch (error) {
        console.error('Error loading achievements:', error);
      }
    }

    // Load health status
    async function loadHealthStatus() {
      try {
        const response = await fetch('/api/health');
        const data = await response.json();
        
        if (data) {
          const container = document.getElementById('healthGrid');
          // Use components if available (structured health data)
          const components = data.components || {};
          const items = Object.keys(components).length > 0 ? components : data;
          
          const healthItems = Object.entries(items)
            .filter(([key]) => !['overall', 'overall_emoji', 'components', 'metrics', 'recent_incidents', 'heartbeat_count_24h', 'version'].includes(key))
            .map(([key, val]) => {
              const status = typeof val === 'string' ? val : (val?.status || val?.state || 'unknown');
              const message = typeof val === 'object' ? (val?.message || '') : '';
              const emoji = typeof val === 'object' ? (val?.emoji || '') : '';
              const indicatorClass = ['healthy', 'ok', 'active', 'green', 'üü¢'].includes(status) ? 'green' : 
                                   ['warning', 'yellow', 'üü°'].includes(status) ? 'yellow' : 
                                   status === 'unknown' ? '' : 'red';
              return `
              <div class="health-item">
                <div class="health-indicator ${indicatorClass}"></div>
                <span class="health-label">${key.replace(/_/g, ' ')}${message ? ': ' + message : ''}</span>
              </div>`;
            }).join('');
          
          // Add version and uptime info
          const version = data.version ? `<div class="health-item"><span class="health-label" style="color: var(--text-dimmer);">v${data.version}</span></div>` : '';
          container.innerHTML = healthItems + version;
        }
      } catch (error) {
        console.error('Error loading health status:', error);
      }
    }

    // Auto-refresh every 30 seconds
    function startAutoRefresh() {
      refreshInterval = setInterval(() => {
        loadDashboard();
        updateUptime();
      }, 30000);
    }

    // Utility functions
    function getMoodEmoji(mood) {
      const emojis = {
        'hyperfocus': 'üéØ',
        'curious': 'ü§î',
        'social': 'üòä',
        'cozy': '‚òï',
        'chaotic': 'üå™Ô∏è',
        'philosophical': 'üß†',
        'restless': '‚ö°',
        'determined': 'üí™'
      };
      return emojis[mood?.toLowerCase()] || 'ü§ñ';
    }

    function formatDuration(seconds) {
      if (seconds < 3600) {
        return `${Math.floor(seconds / 60)}m`;
      } else if (seconds < 86400) {
        return `${Math.floor(seconds / 3600)}h`;
      } else {
        return `${Math.floor(seconds / 86400)}d`;
      }
    }

    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    }

    function getDayPersonality() {
      const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      const personalities = {
        'monday': 'focused',
        'tuesday': 'productive', 
        'wednesday': 'balanced',
        'thursday': 'creative',
        'friday': 'social',
        'saturday': 'experimental',
        'sunday': 'reflective'
      };
      
      const today = days[new Date().getDay()];
      return personalities[today] || 'adaptive';
    }

    function updateUptime() {
      // Simple uptime calculation - could be enhanced with actual system data
      const startTime = localStorage.getItem('dashboardStartTime') || Date.now();
      const uptime = Date.now() - startTime;
      
      if (!localStorage.getItem('dashboardStartTime')) {
        localStorage.setItem('dashboardStartTime', Date.now());
      }
      
      document.getElementById('uptime').textContent = formatDuration(Math.floor(uptime / 1000));
    }

    // Initialize uptime
    updateUptime();
  </script>
</body>
</html>